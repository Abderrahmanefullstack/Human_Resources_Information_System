{% extends 'base.html' %}
{% block content %}
{% load static %}
{% load custom_tags %}

<h2>Agents</h2><br><br><br>

<!-- Import Excel (identique √† tes noms/URL) -->
<form id="importForm" method="POST" enctype="multipart/form-data" action="{% url 'agents:import_excel' %}" class="mb-4">
  {% csrf_token %}
  <div class="input-group">
    <input id="excelInput" type="file" name="excel_file" accept=".xlsx" required class="form-control">
  </div>
</form>

<!-- Dernier import (isol√© proprement, sans table inutile autour) -->
{% if recent_imports %}
<div class="card mt-4 shadow-sm">
  <div class="card-header bg-primary text-white">
    <i class="fas fa-file-import me-2"></i>Dernier import effectu√©
  </div>
  <ul class="list-group list-group-flush">
    <li class="list-group-item d-flex justify-content-between">
      <span><i class="fas fa-file-excel text-success me-2"></i>{{ recent_imports.0.filename }}</span>
      <small class="text-muted">{{ recent_imports.0.import_date|date:"d/m/Y H:i" }}</small>
    </li>
  </ul>
</div>
{% endif %}

<!-- Filtres (un seul formulaire GET, pas de duplication) -->
<form method="get" class="row align-items-end g-2 mb-3 mt-3">
  <div class="col-md-4">
    <input type="text" name="q" class="form-control form-control-sm" style="max-width: 100%;" placeholder="üîç Recherche (nom, pr√©nom, matricule...)" value="{{ filters.q }}">
  </div>

  <div class="col-md-2">
    <select name="annee_retraite" class="form-select form-select-sm">
      <option value="">üéÇ Retrait√©s en...</option>
      {% for year in 2025|get_range_until:2050 %}
        <option value="{{ year }}" {% if filters.annee_retraite|default:'' == year|stringformat:"s" %}selected{% endif %}>üßì {{ year }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <select name="genre" class="form-select form-select-sm">
      <option value="">üé≠ Tous genres</option>
      <option value="H" {% if filters.genre == 'H' %}selected{% endif %}>üë® Hommes</option>
      <option value="F" {% if filters.genre == 'F' %}selected{% endif %}>üë© Femmes</option>
    </select>
  </div>

  <div class="col-md-4 text-end">
    <button type="submit" class="btn btn-sm btn-primary">üîé Filtrer</button>
    <a href="{% url 'agents:list' %}" class="btn btn-sm btn-secondary">‚ôªÔ∏è R√©initialiser</a>
  </div>
</form>

<div class="alert alert-info">Le nombre d'agents trouv√©s : {{ agents|length }}</div>

{% if agents %}
<form id="agentForm" method="get">
  <!-- Boutons d‚Äôaction (noms conserv√©s) -->
  <div class="mb-3 d-flex justify-content-end gap-2">
    
    <a href="{% url 'agents:export_excel' %}?{{ request.GET.urlencode }}" class="btn btn-success me-auto">
      T√©l√©charger le Fichier (Effectif)
    </a>

    <button type="button" class="btn btn-info" onclick="goToAction('view')">üëÅÔ∏è Afficher</button>
    <button type="button" class="btn btn-warning" onclick="goToAction('edit')">‚úèÔ∏è Modifier</button>
    <button type="button" class="btn btn-danger" onclick="goToAction('delete')">üóëÔ∏è Supprimer</button>
    
  </div>

<table class="table table-bordered align-middle">
  <thead>
    <tr>
      <th style="background-color:#B23214; color:#fff;">S√©lection</th>
      <th style="background-color:#B23214; color:#fff;">Matricule</th>
      <th style="background-color:#B23214; color:#fff;">Civilit√©</th>
      <th style="background-color:#B23214; color:#fff;">Nom</th>
      <th style="background-color:#B23214; color:#fff;">Pr√©nom</th>
      <th style="background-color:#B23214; color:#fff;">N¬∞ CNSS</th>
      <th style="background-color:#B23214; color:#fff;">Date Naissance</th>
      <th style="background-color:#B23214; color:#fff;">Date d'entr√©e</th>
      <th style="background-color:#B23214; color:#fff;">Situation Effectif</th>
      <th style="background-color:#B23214; color:#fff;">Affectation Code</th>
      <th style="background-color:#B23214; color:#fff;">Affectation Libell√©</th>
      <th style="background-color:#B23214; color:#fff;">Arborescence Affectation</th>
    </tr>
  </thead>
    <tbody>
      {% for agent in agents %}
      <tr>
        <td class="text-center">
          <input type="radio" name="selected_agent" value="{{ agent.Matricule }}">
        </td>
        <td class="text-center">{{ agent.matricule_formate }}</td>
        <td>{{ agent.Civilite }}</td>
        <td>{{ agent.Nom }}</td>
        <td>{{ agent.Prenom }}</td>
        <td class="text-center">{{ agent.NoAffiliationCNSS }}</td>
        <td class="text-center">{{ agent.DateNaissance|date:"d/m/Y" }}</td>
        <td class="text-center">{{ agent.DateEntree|date:"d/m/Y" }}</td>
        <td>{{ agent.SituationEffectifLibelle }}</td>
        <td class="text-center">{{ agent.affectationCode_formate }}</td>
        <td>{{ agent.AffectationLibelle }}</td>
        <td>{{ agent.ArborescenceAffectation }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</form>
{% else %}
<div class="alert alert-warning">Aucun agent trouv√©.</div>
{% endif %}

<!-- Scripts (identiques en logique, juste rang√©s proprement) -->
<script>
  function confirmImport() {
    return confirm("‚ö†Ô∏è Cela va supprimer toutes les donn√©es existantes. Continuer ?");
  }

  // Auto-submit d√®s qu‚Äôun fichier est choisi
  const excelInput = document.getElementById('excelInput');
  if (excelInput) {
    excelInput.addEventListener('change', function () {
      if (this.files && this.files.length) {
        if (confirmImport()) {
          document.getElementById('importForm').submit();
        } else {
          this.value = '';
        }
      }
    });
  }

  function goToAction(action) {
    console.log("üîç Bouton cliqu√© :", action);

    const selected = document.querySelector('input[name="selected_agent"]:checked');
    if (!selected) {
      alert("‚ùó Veuillez s√©lectionner un agent.");
      console.warn("‚ö†Ô∏è Aucun agent s√©lectionn√©");
      return;
    }

    const matricule = selected.value;
    console.log("‚úÖ Agent s√©lectionn√© :", matricule);

    let url = "";
    if (action === "view") {
      url = `/agents/${matricule}/`;
    } else if (action === "edit") {
      url = `/agents/${matricule}/modifier/`;
    } else if (action === "delete") {
      url = `/agents/${matricule}/supprimer/`;
    } else {
      console.error("‚ùå Action inconnue :", action);
      return;
    }

    console.log("‚û°Ô∏è Redirection vers :", url);
    window.location.href = url;
  }
</script>

{% endblock %}
